<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            line-height: 1.6;
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
        }
        .success { 
            background-color: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background-color: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background-color: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Supabase Connection Test</h1>
    <p>This page tests your Supabase configuration and connection.</p>
    
    <div id="env-check" class="info">
        <h3>Environment Variables Check:</h3>
        <div id="env-results">Checking...</div>
    </div>
    
    <div id="connection-test" class="info">
        <h3>Connection Test:</h3>
        <div id="connection-results">Not tested yet</div>
        <button onclick="testConnection()">Test Connection</button>
    </div>
    
    <div id="database-test" class="info">
        <h3>Database Test:</h3>
        <div id="database-results">Not tested yet</div>
        <button onclick="testDatabase()">Test Database</button>
    </div>
    
    <div id="realtime-test" class="info">
        <h3>Real-time Test:</h3>
        <div id="realtime-results">Not tested yet</div>
        <button onclick="testRealtime()">Test Real-time</button>
    </div>

    <script type="module">
        // Environment Variables Check
        function checkEnvironment() {
            const envResults = document.getElementById('env-results');
            const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
            const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
            
            let html = '';
            
            if (supabaseUrl) {
                html += `<div class="success">‚úÖ VITE_SUPABASE_URL: ${supabaseUrl}</div>`;
            } else {
                html += `<div class="error">‚ùå VITE_SUPABASE_URL: Missing</div>`;
            }
            
            if (supabaseKey) {
                html += `<div class="success">‚úÖ VITE_SUPABASE_ANON_KEY: ${supabaseKey.substring(0, 20)}...</div>`;
            } else {
                html += `<div class="error">‚ùå VITE_SUPABASE_ANON_KEY: Missing</div>`;
            }
            
            envResults.innerHTML = html;
        }
        
        // Test Supabase Connection
        window.testConnection = async function() {
            const results = document.getElementById('connection-results');
            results.innerHTML = '<div class="info">Testing connection...</div>';
            
            try {
                const { createClient } = await import('@supabase/supabase-js');
                const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
                const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
                
                if (!supabaseUrl || !supabaseKey) {
                    throw new Error('Missing environment variables');
                }
                
                const supabase = createClient(supabaseUrl, supabaseKey);
                
                // Test basic connection
                const { data, error } = await supabase.from('users').select('count').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 is "relation does not exist"
                    throw error;
                }
                
                results.innerHTML = '<div class="success">‚úÖ Connection successful! Supabase client created and can communicate with the database.</div>';
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Connection failed: ${error.message}</div>`;
            }
        };
        
        // Test Database Tables
        window.testDatabase = async function() {
            const results = document.getElementById('database-results');
            results.innerHTML = '<div class="info">Testing database tables...</div>';
            
            try {
                const { createClient } = await import('@supabase/supabase-js');
                const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
                const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
                
                const supabase = createClient(supabaseUrl, supabaseKey);
                
                const tables = ['users', 'consultations', 'quotes', 'claims', 'payments', 'activities'];
                let html = '';
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase.from(table).select('count').limit(1);
                        if (error) {
                            if (error.code === 'PGRST116') {
                                html += `<div class="error">‚ùå Table '${table}': Does not exist</div>`;
                            } else {
                                html += `<div class="error">‚ùå Table '${table}': ${error.message}</div>`;
                            }
                        } else {
                            html += `<div class="success">‚úÖ Table '${table}': Accessible</div>`;
                        }
                    } catch (err) {
                        html += `<div class="error">‚ùå Table '${table}': ${err.message}</div>`;
                    }
                }
                
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Database test failed: ${error.message}</div>`;
            }
        };
        
        // Test Real-time
        window.testRealtime = async function() {
            const results = document.getElementById('realtime-results');
            results.innerHTML = '<div class="info">Testing real-time connection...</div>';
            
            try {
                const { createClient } = await import('@supabase/supabase-js');
                const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
                const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
                
                const supabase = createClient(supabaseUrl, supabaseKey);
                
                // Test real-time subscription
                const channel = supabase
                    .channel('test-channel')
                    .on('postgres_changes', { 
                        event: '*', 
                        schema: 'public', 
                        table: 'users' 
                    }, (payload) => {
                        console.log('Real-time update:', payload);
                    })
                    .subscribe((status) => {
                        if (status === 'SUBSCRIBED') {
                            results.innerHTML = '<div class="success">‚úÖ Real-time connection successful!</div>';
                        } else if (status === 'CHANNEL_ERROR') {
                            results.innerHTML = '<div class="error">‚ùå Real-time connection failed</div>';
                        } else {
                            results.innerHTML = `<div class="info">Real-time status: ${status}</div>`;
                        }
                    });
                
                // Cleanup after 5 seconds
                setTimeout(() => {
                    supabase.removeChannel(channel);
                }, 5000);
                
            } catch (error) {
                results.innerHTML = `<div class="error">‚ùå Real-time test failed: ${error.message}</div>`;
            }
        };
        
        // Run environment check on load
        checkEnvironment();
    </script>
</body>
</html>
